(function($) {
    $.fn.longpress = function(callback, duration) {
        duration = duration || 500;
        return this.each(function() {
            var $this = $(this), startTime, timeout, origPos;
            $this.on('mousedown', function(e) {
                origPos = {x: e.clientX, y: e.clientY};
                startTime = new Date().getTime();
                timeout = setTimeout(function() {
                    callback.call($this, e);
                    origPos = null;
                    $this.trigger("mouseup");
                }, duration);
            });
            $this.on('mouseup', function() {
                if (new Date().getTime() - startTime < duration) {
                    origPos = null;
                    clearTimeout(timeout);
                }
            });
            $this.on('mousemove', function(e) {
                if (origPos && (Math.abs(e.clientX-origPos.x) > 3 || Math.abs(e.clientY-origPos.y) > 3)) {
                    clearTimeout(timeout);
                    origPos = null;
                }
            });
        });
    };
}(jQuery));